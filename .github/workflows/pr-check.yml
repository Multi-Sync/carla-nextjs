name: PR Checks

on:
  pull_request:
    branches: [main, develop]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint

      - name: Build project
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Check for breaking changes
        run: |
          if [[ "${{ github.event.pull_request.title }}" =~ ^BREAKING ]]; then
            echo "⚠️ This PR contains breaking changes - will trigger major version bump"
          fi
          if [[ "${{ github.event.pull_request.title }}" =~ ^feat ]]; then
            echo "✨ This PR adds a new feature - will trigger minor version bump"
          fi

      - name: Check package size
        run: |
          npm pack
          SIZE=$(du -h *.tgz | cut -f1)
          echo "📦 Package size: $SIZE"
          if [ $(du -k *.tgz | cut -f1) -gt 5000 ]; then
            echo "⚠️ Warning: Package size exceeds 5MB"
          fi

      - name: Verify files included in package
        run: |
          echo "📋 Files that will be published:"
          npm pack --dry-run

  pr-labeler:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Label PR based on title
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title.toLowerCase();
            const labels = [];

            if (title.startsWith('feat') || title.startsWith('feature')) {
              labels.push('enhancement');
            }
            if (title.startsWith('fix')) {
              labels.push('bug');
            }
            if (title.startsWith('docs')) {
              labels.push('documentation');
            }
            if (title.startsWith('breaking') || title.startsWith('major')) {
              labels.push('breaking-change');
            }
            if (title.startsWith('chore')) {
              labels.push('maintenance');
            }
            if (title.startsWith('test')) {
              labels.push('testing');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
            }
